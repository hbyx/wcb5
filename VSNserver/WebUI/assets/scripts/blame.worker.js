/* Copyright (c) 2020 VisualSVN Software Ltd. All rights reserved. */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";var t=setTimeout;function n(){}function o(e){if(!(this instanceof o))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],h(e,this)}function i(r,n){for(;3===r._state;)r=r._value;0!==r._state?(r._handled=!0,o._immediateFn(function(){var e=1===r._state?n.onFulfilled:n.onRejected;if(null!==e){var t;try{t=e(r._value)}catch(e){return void a(n.promise,e)}s(n.promise,t)}else(1===r._state?s:a)(n.promise,r._value)})):r._deferreds.push(n)}function s(t,e){try{if(e===t)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"==typeof e||"function"==typeof e)){var r=e.then;if(e instanceof o)return t._state=3,t._value=e,void f(t);if("function"==typeof r)return void h((n=r,i=e,function(){n.apply(i,arguments)}),t)}t._state=1,t._value=e,f(t)}catch(e){a(t,e)}var n,i}function a(e,t){e._state=2,e._value=t,f(e)}function f(e){2===e._state&&0===e._deferreds.length&&o._immediateFn(function(){e._handled||o._unhandledRejectionFn(e._value)});for(var t=0,r=e._deferreds.length;t<r;t++)i(e,e._deferreds[t]);e._deferreds=null}function u(e,t,r){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=r}function h(e,t){var r=!1;try{e(function(e){r||(r=!0,s(t,e))},function(e){r||(r=!0,a(t,e))})}catch(e){if(r)return;r=!0,a(t,e)}}o.prototype.catch=function(e){return this.then(null,e)},o.prototype.then=function(e,t){var r=new this.constructor(n);return i(this,new u(e,t,r)),r},o.prototype.finally=function(t){var r=this.constructor;return this.then(function(e){return r.resolve(t()).then(function(){return e})},function(e){return r.resolve(t()).then(function(){return r.reject(e)})})},o.all=function(t){return new o(function(n,i){if(!t||void 0===t.length)throw new TypeError("Promise.all accepts an array");var o=Array.prototype.slice.call(t);if(0===o.length)return n([]);var s=o.length;function a(t,e){try{if(e&&("object"==typeof e||"function"==typeof e)){var r=e.then;if("function"==typeof r)return void r.call(e,function(e){a(t,e)},i)}o[t]=e,0==--s&&n(o)}catch(e){i(e)}}for(var e=0;e<o.length;e++)a(e,o[e])})},o.resolve=function(t){return t&&"object"==typeof t&&t.constructor===o?t:new o(function(e){e(t)})},o.reject=function(r){return new o(function(e,t){t(r)})},o.race=function(i){return new o(function(e,t){for(var r=0,n=i.length;r<n;r++)i[r].then(e,t)})},o._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){t(e,0)},o._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};var e=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}();e.Promise||(e.Promise=o)});var UTF8Decoder=function(){function e(e,t){if(e&&"utf-8"!==e)throw new Error("Cannot create TextDecoder: unsupported 'utfLabel' value.");if(t&&t.fatal)throw new Error("Cannot create TextDecoder: the 'fatal' option is unsupported.");if(t&&t.ignoreBOM)throw new Error("Cannot create TextDecoder: the 'ignoreBOM' option is unsupported.");this.encoding="utf-8",this.fatal=!1,this.ignoreBOM=!1}return e.prototype.decode=function(e,t){if(t&&t.stream)throw new Error("Cannot decode data: the 'stream' option is unsupported.");for(var r,n=0,i=(r=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength)).length,o=[];n<i;){var s=r[n++];if(0==(128&s))o.push(s);else if(192==(224&s)){var a=63&r[n++];o.push((31&s)<<6|a)}else if(224==(240&s)){a=63&r[n++];var f=63&r[n++];o.push((31&s)<<12|a<<6|f)}else if(240==(248&s)){var u=(7&s)<<18|(a=63&r[n++])<<12|(f=63&r[n++])<<6|63&r[n++];65535<u&&(u-=65536,o.push(u>>>10&1023|55296),u=56320|1023&u),o.push(u)}else o.push(65533)}for(var h="",l=0;l<o.length;){var c=Math.min(1024,o.length-l);h+=String.fromCharCode.apply(null,o.slice(l,l+c)),l+=c}return h},e}();function makeParseError(){return new Error("Unexpected data in the stream.")}"TextDecoder"in self||(self.TextDecoder=UTF8Decoder);var DiffImpl,WireProtocolParser=function(){function e(){this.utf8Decoder=new TextDecoder("utf-8",{fatal:!1}),this.buffer=null,this.offset=0,this.pos=0,this.view=null,this.done=!1}return e.prototype.parse=function(e){if(null===this.buffer)this.buffer=e;else{var t=this.buffer.subarray(this.offset+this.pos);this.buffer=new Uint8Array(t.byteLength+e.byteLength),this.buffer.set(t,0),this.buffer.set(e,t.byteLength)}for(this.offset=0,this.pos=0,this.view=new DataView(this.buffer.buffer,this.buffer.byteOffset,this.buffer.byteLength);;)switch(this.parseImpl()){case 2:if(this.offset+=this.pos,this.pos=0,this.done=!0,this.hasBytes(1))throw makeParseError();return;case 1:return void(this.pos=0);case 0:this.offset+=this.pos,this.pos=0}},e.prototype.finish=function(){for(;!this.done;)switch(this.parseImpl()){case 2:if(this.offset+=this.pos,this.pos=0,this.done=!0,this.hasBytes(1))throw makeParseError();break;case 1:throw makeParseError();case 0:this.offset+=this.pos,this.pos=0}},e.prototype.readBoolean=function(){var e=this.readUint8();if(void 0!==e)return 0!==e},e.prototype.readString=function(e){var t=this.readUint32();if(void 0!==t){if(4294967295===t){if(e)return null;throw makeParseError()}var r=this.readUint8Array(t);if(void 0!==r)return this.utf8Decoder.decode(r)}},e.prototype.readUint8=function(){if(this.hasBytes(1)){var e=this.view.getUint8(this.offset+this.pos);return this.pos+=1,e}},e.prototype.readUint32=function(){if(this.hasBytes(4)){var e=this.view.getUint32(this.offset+this.pos,!0);return this.pos+=4,e}},e.prototype.readUint64=function(){var e=this.readUint32();if(void 0!==e){var t=this.readUint32();if(void 0!==t){if(0===t)return e;var r=4294967296*t+e;if(r<=9007199254740991)return r;throw makeParseError()}}},e.prototype.readUint8Array=function(e){if(this.hasBytes(e)){var t=this.buffer.subarray(this.offset+this.pos,this.offset+this.pos+e);return this.pos+=e,t}},e.prototype.hasBytes=function(e){return this.buffer.byteLength-(this.offset+this.pos)>=e},e}();!function(e){function r(e){var t=e.split(/\r\n|\n|\r/);return""===t[t.length-1]&&t.pop(),t}function n(e,t){for(var r=function(e,t){for(var r=e.length,n=t.length,i=r-n,o=r+n+3,s=n+1,a=[],f=0;f<o;f++)a.push({x:0,y:-1,lcs:null});var u=0;do{for(var h=(i<0?i:0)-u;h<0;h++)c(a,e,t,h+s);for(var h=(0<i?i:0)+u;0<=h;h--)c(a,e,t,h+s);u++}while(a[s].y!=n);var l=a[s].lcs;return l=function(e){for(var t,r=null;e;)t=e.link,e.link=r,r=e,e=t;return r}(l=d(l,r,n,0))}(e,t),n=0,i=0,o=[];n<r.x&&o.push({added:void 0,removed:!0,value:e.slice(n,r.x)}),i<r.y&&o.push({added:!0,removed:void 0,value:t.slice(i,r.y)}),r.len;)o.push({added:void 0,removed:void 0,value:e.slice(r.x,r.x+r.len)}),n=r.x+r.len,i=r.y+r.len,r=r.link;return o}function d(e,t,r,n){return{x:t,y:r,len:n,link:e}}function c(e,t,r,n){var i,o,s,a=t.length,f=r.length,u=e[n-1],h=e[n+1];u.y>=h.y?(i=u.x,o=u.y+1,s=u.lcs):(i=h.x+1,o=h.y,s=h.lcs);for(var l=i,c=o;l<a&&c<f&&t[l]===r[c];)l++,c++;i<l&&(s=d(s,i,o,l-i)),e[n].x=l,e[n].y=c,e[n].lcs=s}e.diffLines=function(e,t){return t===e?[{value:r(t),removed:void 0,added:void 0}]:t?e?n(r(e),r(t)):[{value:r(t),removed:void 0,added:!0}]:[{value:r(e),removed:!0,added:void 0}]},e.tokenize=r,e.diff=n}(DiffImpl||(DiffImpl={}));var BlameImpl,__awaiter=this&&this.__awaiter||function(o,s,a,f){return new(a||(a=Promise))(function(e,t){function r(e){try{i(f.next(e))}catch(e){t(e)}}function n(e){try{i(f.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,n)}i((f=f.apply(o,s||[])).next())})},__generator=this&&this.__generator||function(r,n){var i,o,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,o=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=n.call(r,a)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();!function(e){var o=function(){function e(e){this.progressCb=e,this.utf8Decoder=new TextDecoder("utf-8",{fatal:!1}),this.blame=void 0,this.delta=new SvnTxdelta(new Uint8Array(0)),this.prevContents=void 0,this.prevLines=[],this.prevFileRev=void 0}return e.prototype.onCloseFileRev=function(e,t){if(this.progressCb&&this.progressCb(e.rev),t){for(var r=this.delta.getResult(),n=this.utf8Decoder.decode(r),i=DiffImpl.tokenize(n),o=DiffImpl.diff(this.prevLines,i),s=new Array,a=0,f=0;f<o.length;f++)for(var u=0<f?o[f-1]:void 0,h=o[f],l=0,c=h.value;l<c.length;l++){c[l];h.added?u&&u.removed?s.push({fileRev:e,prevFileRev:this.prevFileRev,prevStartLine:a-u.value.length,prevEndLine:a}):s.push({fileRev:e,prevFileRev:this.prevFileRev,prevStartLine:a,prevEndLine:a}):(h.removed||s.push(this.blame[a]),a++)}this.blame=s,this.delta=new SvnTxdelta(r),this.prevContents=n,this.prevLines=i,this.prevFileRev=e}},e.prototype.onTxdeltaWindow=function(e){this.delta.applyWindow(e)},e.prototype.onDone=function(){},e.prototype.getBlame=function(){return this.blame},e.prototype.getTextContent=function(){return this.prevContents},e}();function u(e,t){return new Error("Unexpected HTTP status "+e+" '"+t+"'.")}e.blame=function(e,t,r,n){var i=new o(n);return function(o,s,a,f){return __awaiter(this,void 0,void 0,function(){var n,t,r,i;return __generator(this,function(e){switch(e.label){case 0:return n='<S:file-revs-report xmlns:S="svn:">',n+="<S:path></S:path>",null!==s&&(n+="<S:start-revision>"+s.toString(10)+"</S:start-revision>"),null!==a&&(n+="<S:end-revision>"+a.toString(10)+"</S:end-revision>"),n+="</S:file-revs-report>","fetch"in self&&"ReadableStream"in self?[4,fetch(o,{method:"REPORT",body:n,credentials:"same-origin",headers:{Accept:"application/vnd.vsvn-wireprotocol"}})]:[3,5];case 1:if(200!==(t=e.sent()).status)throw u(t.status,t.statusText);r=t.body.getReader(),e.label=2;case 2:return[4,r.read()];case 3:return(i=e.sent()).done?(f.finish(),[3,4]):(f.parse(i.value),[3,2]);case 4:return[3,6];case 5:return[2,new Promise(function(e,t){var r=new XMLHttpRequest;r.open("REPORT",o,!0),r.responseType="arraybuffer",r.onload=function(){if(200===r.status)try{f.parse(new Uint8Array(r.response)),f.finish(),e()}catch(e){t(e)}else t(u(r.status,r.statusText))},r.onerror=function(){t(new Error("HTTP request failed."))},r.setRequestHeader("Accept","application/vnd.vsvn-wireprotocol"),r.send(n)})];case 6:return[2]}})})}(e,t,r,new FileRevsParser(i)).then(function(){return{blame:i.getBlame(),textContent:i.getTextContent()}})}}(BlameImpl||(BlameImpl={}));var FileRevsParser=function(r){function s(e){var t=r.call(this)||this;return t.cb=e,t.state=0,t}return __extends(s,r),s.prototype.parseImpl=function(){switch(this.state){case 0:var e=this.readBoolean();if(void 0===e)return 1;if(e){var t=this.readFileRev();if(void 0===t)return 1;var r=this.readBoolean();if(void 0===r)return;r?(this.fileRev=t,this.state=1):this.cb.onCloseFileRev(t,!1)}else this.state=2,this.cb.onDone();return 0;case 1:var n=this.readBoolean();if(void 0===n)return 1;if(n){var i=this.readTxdeltaWindow();if(void 0===i)return 1;this.cb.onTxdeltaWindow(i)}else this.cb.onCloseFileRev(this.fileRev,!0),this.fileRev=void 0,this.state=0;return 0;case 2:return 2;default:return assertNever(this.state)}},s.prototype.readFileRev=function(){var e={};if(e.path=this.readString(),void 0!==e.path&&(e.rev=this.readUint32(),void 0!==e.rev&&(e.revprops=this.readFileRevRevprops(),void 0!==e.revprops))){var t=this.readUint32();if(void 0!==t){for(var r=0;r<t;r++){if(void 0===this.readString())return;var n=this.readBoolean();if(void 0===n)return;if(n)if(void 0===this.readString())return}if(void 0!==this.readBoolean())return e}}},s.prototype.readFileRevRevprops=function(){var e={},t=this.readUint32();if(void 0!==t){for(var r=0;r<t;r++){var n=this.readString();if(void 0===n)return;var i=this.readString();if(void 0===i)return;switch(n){case"svn:date":e.date=new Date(i);break;case"svn:log":e.log=i;break;case"svn:author":e.author=i}}return e}},s.prototype.readTxdeltaWindow=function(){var e=102400,t={};if(t.sviewOffset=this.readUint64(),void 0!==t.sviewOffset&&(t.sviewLen=this.readUint32(),void 0!==t.sviewLen)){if(t.sviewLen>e)throw new Error("Unexpected text delta window.");if(t.tviewLen=this.readUint32(),void 0!==t.tviewLen){if(t.tviewLen>e)throw new Error("Unexpected text delta window.");var r=this.readUint32();if(void 0!==r&&(t.srcOps=this.readUint32(),void 0!==t.srcOps)){t.ops=new Array;for(var n=0;n<r;n++){var i=this.readTxdeltaOp();if(void 0===i)return;t.ops.push(i)}var o=this.readUint32();if(void 0!==o){if(e<o)throw new Error("Unexpected text delta window.");if(t.newData=this.readUint8Array(o),void 0!==t.newData){if(!s.validateTxdeltaWindow(t))throw new Error("Unexpected text delta window.");return t}}}}}},s.validateTxdeltaWindow=function(e){for(var t=0,r=0,n=0;n<e.ops.length;n++){var i=e.ops[n];if(0===i.length)return!1;if(i.length>e.tviewLen-t)return!1;switch(i.action){case 0:if(i.length>e.sviewLen-i.offset||i.offset>e.sviewLen)return!1;break;case 1:if(i.offset>=t)return!1;break;case 2:if(i.length>e.newData.byteLength-r)return!1;r+=i.length}t+=i.length}return t===e.tviewLen&&r===e.newData.byteLength},s.prototype.readTxdeltaOp=function(){var e={};if(e.action=this.readUint32(),void 0!==e.action){switch(e.action){case 0:case 1:case 2:break;default:throw new Error("Unexpected text delta instruction.")}if(e.offset=this.readUint32(),void 0!==e.offset&&(e.length=this.readUint32(),void 0!==e.length))return e}},s}(WireProtocolParser),SvnTxdelta=function(){function e(e){this.source=e,this.target=new Array,this.targetLen=0}return e.prototype.applyWindow=function(r){var n=this.source.subarray(r.sviewOffset,r.sviewOffset+r.sviewLen),i=new Uint8Array(r.tviewLen),o=0;r.ops.forEach(function(e){switch(e.action){case 0:i.set(n.subarray(e.offset,e.offset+e.length),o);break;case 1:if(e.offset+e.length>o)for(var t=0;t<e.length;t++)i[o+t]=i[e.offset+t];else i.set(i.subarray(e.offset,e.offset+e.length),o);break;case 2:i.set(r.newData.subarray(e.offset,e.offset+e.length),o);break;default:assertNever(e.action)}o+=e.length}),this.target.push(i),this.targetLen+=i.byteLength},e.prototype.getResult=function(){for(var e=new Uint8Array(this.targetLen),t=0,r=0;r<this.target.length;r++)e.set(this.target[r],t),t+=this.target[r].byteLength;return e},e}();function assertNever(e){return e}addEventListener("message",function(e){var t=this,r=e.data;BlameImpl.blame(r.url,r.startRev,r.endRev,function(e){t.postMessage({progress:e})}).then(function(e){t.postMessage({result:e}),close()}).catch(function(e){t.postMessage({error:e.message}),close()})});