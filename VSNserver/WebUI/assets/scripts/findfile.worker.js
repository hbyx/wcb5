/* Copyright (c) 2020 VisualSVN Software Ltd. All rights reserved. */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(0,function(){"use strict";var e=setTimeout;function n(){}function o(t){if(!(this instanceof o))throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],h(t,this)}function i(r,n){for(;3===r._state;)r=r._value;0!==r._state?(r._handled=!0,o._immediateFn(function(){var t=1===r._state?n.onFulfilled:n.onRejected;if(null!==t){var e;try{e=t(r._value)}catch(t){return void a(n.promise,t)}s(n.promise,e)}else(1===r._state?s:a)(n.promise,r._value)})):r._deferreds.push(n)}function s(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var r=t.then;if(t instanceof o)return e._state=3,e._value=t,void f(e);if("function"==typeof r)return void h((n=r,i=t,function(){n.apply(i,arguments)}),e)}e._state=1,e._value=t,f(e)}catch(t){a(e,t)}var n,i}function a(t,e){t._state=2,t._value=e,f(t)}function f(t){2===t._state&&0===t._deferreds.length&&o._immediateFn(function(){t._handled||o._unhandledRejectionFn(t._value)});for(var e=0,r=t._deferreds.length;e<r;e++)i(t,t._deferreds[e]);t._deferreds=null}function u(t,e,r){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.promise=r}function h(t,e){var r=!1;try{t(function(t){r||(r=!0,s(e,t))},function(t){r||(r=!0,a(e,t))})}catch(t){if(r)return;r=!0,a(e,t)}}o.prototype.catch=function(t){return this.then(null,t)},o.prototype.then=function(t,e){var r=new this.constructor(n);return i(this,new u(t,e,r)),r},o.prototype.finally=function(e){var r=this.constructor;return this.then(function(t){return r.resolve(e()).then(function(){return t})},function(t){return r.resolve(e()).then(function(){return r.reject(t)})})},o.all=function(e){return new o(function(n,i){if(!e||void 0===e.length)throw new TypeError("Promise.all accepts an array");var o=Array.prototype.slice.call(e);if(0===o.length)return n([]);var s=o.length;function a(e,t){try{if(t&&("object"==typeof t||"function"==typeof t)){var r=t.then;if("function"==typeof r)return void r.call(t,function(t){a(e,t)},i)}o[e]=t,0==--s&&n(o)}catch(t){i(t)}}for(var t=0;t<o.length;t++)a(t,o[t])})},o.resolve=function(e){return e&&"object"==typeof e&&e.constructor===o?e:new o(function(t){t(e)})},o.reject=function(r){return new o(function(t,e){e(r)})},o.race=function(i){return new o(function(t,e){for(var r=0,n=i.length;r<n;r++)i[r].then(t,e)})},o._immediateFn="function"==typeof setImmediate&&function(t){setImmediate(t)}||function(t){e(t,0)},o._unhandledRejectionFn=function(t){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",t)};var t=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}();t.Promise||(t.Promise=o)});var UTF8Decoder=function(){function t(t,e){if(t&&"utf-8"!==t)throw new Error("Cannot create TextDecoder: unsupported 'utfLabel' value.");if(e&&e.fatal)throw new Error("Cannot create TextDecoder: the 'fatal' option is unsupported.");if(e&&e.ignoreBOM)throw new Error("Cannot create TextDecoder: the 'ignoreBOM' option is unsupported.");this.encoding="utf-8",this.fatal=!1,this.ignoreBOM=!1}return t.prototype.decode=function(t,e){if(e&&e.stream)throw new Error("Cannot decode data: the 'stream' option is unsupported.");for(var r,n=0,i=(r=t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength)).length,o=[];n<i;){var s=r[n++];if(0==(128&s))o.push(s);else if(192==(224&s)){var a=63&r[n++];o.push((31&s)<<6|a)}else if(224==(240&s)){a=63&r[n++];var f=63&r[n++];o.push((31&s)<<12|a<<6|f)}else if(240==(248&s)){var u=(7&s)<<18|(a=63&r[n++])<<12|(f=63&r[n++])<<6|63&r[n++];65535<u&&(u-=65536,o.push(u>>>10&1023|55296),u=56320|1023&u),o.push(u)}else o.push(65533)}for(var h="",l=0;l<o.length;){var c=Math.min(1024,o.length-l);h+=String.fromCharCode.apply(null,o.slice(l,l+c)),l+=c}return h},t}();function makeParseError(){return new Error("Unexpected data in the stream.")}"TextDecoder"in self||(self.TextDecoder=UTF8Decoder);var worker,WireProtocolParser=function(){function t(){this.utf8Decoder=new TextDecoder("utf-8",{fatal:!1}),this.buffer=null,this.offset=0,this.pos=0,this.view=null,this.done=!1}return t.prototype.parse=function(t){if(null===this.buffer)this.buffer=t;else{var e=this.buffer.subarray(this.offset+this.pos);this.buffer=new Uint8Array(e.byteLength+t.byteLength),this.buffer.set(e,0),this.buffer.set(t,e.byteLength)}for(this.offset=0,this.pos=0,this.view=new DataView(this.buffer.buffer,this.buffer.byteOffset,this.buffer.byteLength);;)switch(this.parseImpl()){case 2:if(this.offset+=this.pos,this.pos=0,this.done=!0,this.hasBytes(1))throw makeParseError();return;case 1:return void(this.pos=0);case 0:this.offset+=this.pos,this.pos=0}},t.prototype.finish=function(){for(;!this.done;)switch(this.parseImpl()){case 2:if(this.offset+=this.pos,this.pos=0,this.done=!0,this.hasBytes(1))throw makeParseError();break;case 1:throw makeParseError();case 0:this.offset+=this.pos,this.pos=0}},t.prototype.readBoolean=function(){var t=this.readUint8();if(void 0!==t)return 0!==t},t.prototype.readString=function(t){var e=this.readUint32();if(void 0!==e){if(4294967295===e){if(t)return null;throw makeParseError()}var r=this.readUint8Array(e);if(void 0!==r)return this.utf8Decoder.decode(r)}},t.prototype.readUint8=function(){if(this.hasBytes(1)){var t=this.view.getUint8(this.offset+this.pos);return this.pos+=1,t}},t.prototype.readUint32=function(){if(this.hasBytes(4)){var t=this.view.getUint32(this.offset+this.pos,!0);return this.pos+=4,t}},t.prototype.readUint64=function(){var t=this.readUint32();if(void 0!==t){var e=this.readUint32();if(void 0!==e){if(0===e)return t;var r=4294967296*e+t;if(r<=9007199254740991)return r;throw makeParseError()}}},t.prototype.readUint8Array=function(t){if(this.hasBytes(t)){var e=this.buffer.subarray(this.offset+this.pos,this.offset+this.pos+t);return this.pos+=t,e}},t.prototype.hasBytes=function(t){return this.buffer.byteLength-(this.offset+this.pos)>=t},t}(),__extends=this&&this.__extends||function(){var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};return function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),__awaiter=this&&this.__awaiter||function(o,s,a,f){return new(a||(a=Promise))(function(t,e){function r(t){try{i(f.next(t))}catch(t){e(t)}}function n(t){try{i(f.throw(t))}catch(t){e(t)}}function i(e){e.done?t(e.value):new a(function(t){t(e.value)}).then(r,n)}i((f=f.apply(o,s||[])).next())})},__generator=this&&this.__generator||function(r,n){var i,o,s,t,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,o&&(s=2&e[0]?o.return:e[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,e[1])).done)return s;switch(o=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return a.label++,{value:e[1],done:!1};case 5:a.label++,o=e[1],e=[0];continue;case 7:e=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){a=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){a.label=e[1];break}if(6===e[0]&&a.label<s[1]){a.label=s[1],s=e;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(e);break}s[2]&&a.ops.pop(),a.trys.pop();continue}e=n.call(r,a)}catch(t){e=[6,t],o=0}finally{i=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}},FETCH_LIMIT=5e5,RESULT_LIMIT=20,FindFileWorker=function(n){function t(t,e){var r=n.call(this)||this;return r.url=t,r.scope=self,r.allItems=[],r.fetchDone=!1,r.hitSearchLimit=!1,r.filteredItems=[],r.setFilter(e),r.findFileAsync().catch(function(t){r.scope.postMessage({error:t.message}),r.scope.close()}),r}return __extends(t,n),t.prototype.findFileAsync=function(){return __awaiter(this,void 0,void 0,function(){var n,e,r,i,o=this;return __generator(this,function(t){switch(t.label){case 0:return n="<V:findfile-report xmlns:V='visualsvn:'><V:limit>"+FETCH_LIMIT.toString()+"</V:limit></V:findfile-report>","fetch"in self&&"ReadableStream"in self?(this.incrementalUpdates=!0,this.progress=0,[4,fetch(this.url,{method:"REPORT",body:n,credentials:"same-origin",headers:{Accept:"application/vnd.vsvn-wireprotocol"}})]):[3,5];case 1:if(200!==(e=t.sent()).status)throw new Error("Unexpected HTTP status "+e.status+" '"+e.statusText+"'.");r=e.body.getReader(),t.label=2;case 2:return[4,r.read()];case 3:return(i=t.sent()).done?(this.finish(),[3,4]):(this.parse(i.value),[3,2]);case 4:return[3,6];case 5:return this.incrementalUpdates=!1,this.progress=null,this.postUpdate(),[2,new Promise(function(t,e){var r=new XMLHttpRequest;r.open("REPORT",o.url,!0),r.responseType="arraybuffer",r.onload=function(){if(200===r.status)try{o.parse(new Uint8Array(r.response)),o.finish(),t()}catch(t){e(t)}else e(new Error("Unexpected HTTP status "+r.status+" '"+r.statusText+"'."))},r.onerror=function(){e(new Error("HTTP request failed."))},r.setRequestHeader("Accept","application/vnd.vsvn-wireprotocol"),r.send(n)})];case 6:return[2]}})})},t.prototype.setFilter=function(t){for(var e=!1,r="",n=0,i=this.filter=t;n<i.length;n++){var o=i[n];"*"===o?(r+=".*",e=!0):"?"===o?(r+=".",e=!0):(-1!==".+^${}()|[]\\".indexOf(o)&&(r+="\\"),r+=o)}e&&(r="^"+r+"$"),this.filterRegex=new RegExp(r,"i")},t.prototype.alterFilter=function(t,e){if(this.setFilter(t),e){this.filteredItems=[];for(var r=0,n=this.allItems;r<n.length;r++){var i=n[r],o=this.filterItem(i);if(o&&this.filteredItems.push(o),this.filteredItems.length===RESULT_LIMIT)break}this.postUpdate()}else this.filteredItems=null},t.prototype.filterItem=function(t){if(0===this.filter.length)return null;if(0===t.name.length)return null;if(t.name.match(this.filterRegex)){for(var e=[],r=new RegExp(this.filterRegex.source,"gi"),n=0;;){var i=r.exec(t.name);if(!i||!i[0]){n<t.name.length&&e.push({text:t.name.substr(n),isMatch:!1});break}if(n<i.index){var o=i.index-n;e.push({text:t.name.substr(n,o),isMatch:!1}),n+=o}e.push({text:i[0],isMatch:!0}),n+=i[0].length}return{parentRelpath:t.parentRelpath,name:t.name,nameSpans:e,isDir:t.isDir}}return null},t.prototype.postUpdate=function(){var t={filter:this.filter,items:this.filteredItems,incremental:!this.fetchDone,hitSearchLimit:this.hitSearchLimit,hitResultLimit:this.filteredItems.length===RESULT_LIMIT,progress:this.progress};this.scope.postMessage({result:t})},t.prototype.parseImpl=function(){var t=this.readString(!0);if(void 0===t)return 1;if(null===t){var e=this.readBoolean();return void 0===e?1:(this.fetchDone=!0,this.hitSearchLimit=e,this.progress=1,this.postUpdate(),2)}var r=this.readUint64();if(void 0===r)return 1;var n=this.readBoolean();if(void 0===n)return 1;var i="";if(0<r){var o=this.allItems[r];o.parentRelpath&&(i+=o.parentRelpath,i+="/"),i+=o.name}var s={parentRelpath:i,name:t,isDir:n};this.allItems.push(s);var a=!1,f=this.allItems.length/FETCH_LIMIT;if(Math.floor(100*f)!==Math.floor(100*this.progress)&&(this.progress=f,a=!0),this.filteredItems){if(this.filteredItems.length<RESULT_LIMIT)(l=this.filterItem(s))&&(this.filteredItems.push(l),a=!0)}else{this.filteredItems=[];for(var u=0,h=this.allItems;u<h.length;u++){var l,c=h[u];if((l=this.filterItem(c))&&this.filteredItems.push(l),this.filteredItems.length===RESULT_LIMIT)break}a=!0}return this.incrementalUpdates&&a&&this.postUpdate(),0},t}(WireProtocolParser);addEventListener("message",function(t){var e=t.data;worker?worker.alterFilter(e.filter,e.postUpdate):worker=new FindFileWorker(e.url,e.filter)});